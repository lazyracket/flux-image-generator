<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flux æ‰¹é‡ç”Ÿå›¾å°å·¥å…·</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css">
    <style>
        body {
            font-family: "LXGW WenKai", sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
            color: #333;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
        }
        textarea, input, select {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            min-width: 120px;
        }
        button:hover {
            background-color: #2980b9;
        }
        #imageContainer {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }
        .image-card {
            width: 30%;
            margin-bottom: 20px;
            text-align: center;
            background-color: #fff;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            overflow: hidden;
            padding-bottom: 10px;
        }
        .image-card img {
            max-width: 100%;
            height: auto;
            display: block;
            margin-bottom: 10px;
        }
        .image-checkbox {
            display: block;
            margin: 10px auto;
        }
        .image-card p {
            margin: 5px 0;
            padding: 0 10px;
        }
        #progressBar {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        #progressBar div {
            height: 20px;
            background-color: #2ecc71;
            text-align: center;
            line-height: 20px;
            color: white;
            transition: width 0.5s;
        }
        #quotaInfo {
            margin-top: 10px;
            font-size: 14px;
            color: #7f8c8d;
        }
        .dark-mode {
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        .dark-mode .container {
            background-color: #34495e;
        }
        .dark-mode h1 {
            color: #3498db;
        }
        .dark-mode textarea, .dark-mode input, .dark-mode select {
            background-color: #2c3e50;
            color: #ecf0f1;
            border-color: #7f8c8d;
        }
        .dark-mode button {
            background-color: #e74c3c;
        }
        .dark-mode button:hover {
            background-color: #c0392b;
        }
        .dark-mode .image-card {
            background-color: #34495e;
            color: #ecf0f1;
        }
        .dark-mode #progressBar {
            background-color: #7f8c8d;
        }
        .advanced-settings {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .advanced-settings h3 {
            margin-top: 0;
        }
        .advanced-settings label {
            display: block;
            margin-bottom: 5px;
        }
        .api-key-hint {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
            margin-bottom: 10px;
        }
        .dark-mode .api-key-hint {
            color: #bdc3c7;
        }
        #promptHelperButton {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
        }
        #promptHelperButton:hover {
            background-color: #27ae60;
        }
        #promptInstructions {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        #promptInstructions pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        #promptInstructions a {
            color: #3498db;
            text-decoration: none;
        }
        #promptInstructions a:hover {
            text-decoration: underline;
        }
        #promptInput {
            width: 100%;
            margin-bottom: 20px;
        }
        label[for="promptInput"], .advanced-settings h3 {
            display: block;
            margin-bottom: 10px;
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        .dark-mode label[for="promptInput"], .dark-mode .advanced-settings h3 {
            color: #3498db;
        }
        #progressBar {
            margin-top: 20px;
        }
        #progressText, #quotaInfo {
            margin-top: 10px;
        }
        .dark-mode #promptInstructions {
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        .dark-mode #promptInstructions a {
            color: #3498db;
        }
        .dark-mode #promptInstructions pre {
            background-color: #34495e;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
        }
        .dark-mode .advanced-settings {
            background-color: #34495e;
            color: #ecf0f1;
        }
        .dark-mode .advanced-settings select,
        .dark-mode .advanced-settings input {
            background-color: #2c3e50;
            color: #ecf0f1;
            border-color: #7f8c8d;
        }
        a {
            color: #3498db;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .dark-mode a {
            color: #5dade2;
        }
        .dark-mode a:hover {
            color: #3498db;
        }
        .red-text {
            color: #e74c3c;
        }
        .image-checkbox {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
        }
        .image-card {
            position: relative;
        }
        #selectAllButton, #downloadButton {
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .checkbox-label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        .image-checkbox {
            margin-right: 5px;
        }
        #downloadInstructions {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        #downloadInstructions ul {
            padding-left: 20px;
        }
        .dark-mode #downloadInstructions {
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        .dark-mode .checkbox-label {
            background-color: rgba(52, 73, 94, 0.7);
            color: #ecf0f1;
        }
        .checkbox-wrapper {
            text-align: left;
            padding: 0 10px;
            margin-top: 5px;
        }
        .image-checkbox {
            margin: 0;
        }
        .image-wrapper {
            position: relative;
        }
        .image-card img {
            max-width: 100%;
            height: auto;
            display: block;
        }
        .image-checkbox {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
        }
        .image-card p {
            margin: 10px 0;
            padding: 0 10px;
        }
        #apiKeyInput, #promptInput, #seed, #generationMode {
            width: 100%;
        }
        .image-card p.prompt {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 2.4em;  /* å‡è®¾è¡Œé«˜ä¸º1.2em */
            line-height: 1.2em;
        }
        #darkModeToggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 24px;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: normal; /* å…è®¸æ–‡æœ¬æ¢è¡Œ */
            line-height: 1.2; /* è°ƒæ•´è¡Œé«˜ */
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .image-card p {
            margin: 5px 0;
            padding: 0 10px;
            font-size: 14px;
        }
        .image-card .prompt {
            font-weight: bold;
            margin-bottom: 10px;
        }
        #resetButton {
            background-color: #e74c3c;
        }
        #resetButton:hover {
            background-color: #c0392b;
        }
        #selectAllButton, #downloadButton, #resetButton {
            display: inline-block;
            vertical-align: middle;
        }
        .tooltip {
            display: inline-block;
            vertical-align: middle;
        }
        #generationControls, #imageControls {
            margin-bottom: 10px;
        }
        #generationControls button, #imageControls button {
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        .tooltip {
            display: inline-block;
            vertical-align: middle;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 14px;
            min-width: 120px;
        }
        button:hover {
            background-color: #2980b9;
        }
        #resetButton {
            background-color: #e74c3c;
        }
        #resetButton:hover {
            background-color: #c0392b;
        }
        #resetButton, #downloadButton {
            min-width: 140px;  /* ç¨å¾®å¢åŠ å®½åº¦ä»¥é€‚åº”æ›´é•¿çš„æ–‡æœ¬ */
        }
    </style>
</head>
<body>
    <div class="container">
        <button id="darkModeToggle" onclick="toggleDarkMode()">ğŸŒ“</button>
        <h1>Flux æ‰¹é‡ç”Ÿå›¾å°å·¥å…·</h1>
        <p>æ„Ÿè°¢<a href="https://www.siliconflow.com/" target="_blank">ç¡…åŸºæµåŠ¨</a>æä¾›çš„APIæ”¯æŒã€‚è¯·å‹¿æ»¥ç”¨æ­¤å·¥å…·ï¼Œéµå®ˆç›¸å…³æ³•å¾‹æ³•è§„ã€‚</p>
        <input type="password" id="apiKeyInput" placeholder="è¾“å…¥æ‚¨çš„APIå¯†é’¥">
        <p class="api-key-hint">ç½‘ç«™æ³¨å†Œä¹‹åï¼Œè¿›å…¥è´¦æˆ·ç®¡ç†ï¼Œæ–°å»ºAPIå¯†é’¥å³å¯ã€‚</p>
        <div id="promptInstructions">
            <p><strong class="red-text">è¾“å…¥æç¤ºè¯ï¼Œæ¯è¡Œä¸€ä¸ªæ–°çš„æç¤ºè¯ã€‚åªè¦æŒ‰"å›è½¦"é”®ï¼Œå°±ä¼šå¼€å§‹ä¸€ä¸ªæ–°çš„æç¤ºè¯ã€‚</strong></p>
            <p>æ ¼å¼ï¼šæç¤ºè¯+æƒé‡ï¼ˆæƒé‡å¯é€‰ï¼Œä¸å†™å°±é»˜è®¤ä¸º1ï¼›æƒé‡è¶Šé«˜ï¼Œä½¿ç”¨è¯¥æç¤ºè¯ç”Ÿæˆå›¾ç‰‡çš„æ¬¡æ•°è¶Šå¤šã€‚ï¼‰</p>
            <p>ç¤ºä¾‹ï¼š</p>
            <pre>
A beautiful garden with blooming flowers under bright sunlight
An ancient castle perched on a cliff, shrouded in mist+1.5
Futuristic cityscape with flying cars and neon lights
A young woman with long black hair, wearing a red dress, standing in a forest clearing, soft sunlight filtering through the trees+2</pre>
            <p>éœ€è¦å¸®åŠ©ç”Ÿæˆæç¤ºè¯ï¼Ÿå¯ä»¥å‚è€ƒ<a href="https://www.coze.cn/store/agent/7411101906900140070" target="_blank">æç¤ºè¯ç”ŸæˆåŠ©æ‰‹</a>ã€‚</p>
            <p><strong>æ³¨æ„ï¼šå¦‚æœç”Ÿæˆçš„ä¸€ä»½æç¤ºè¯åŒ…æ‹¬æœ‰å¥½å‡ æ®µæ–‡å­—ï¼Œå°±æ‰‹åŠ¨æ”¹ä¸€ä¸‹æ ¼å¼ï¼Œåˆ«æ¢è¡Œã€‚</strong></p>
        </div>
        <label for="promptInput"><strong>åœ¨ä¸‹æ–¹è¾“å…¥æ‚¨çš„æç¤ºè¯ï¼š</strong></label>
        <textarea id="promptInput" rows="10"></textarea>
        <select id="generationMode">
            <option value="smart">æ™ºèƒ½æ¨¡å¼ï¼ˆè‡ªåŠ¨åˆ†é…ç”Ÿæˆæ¬¡æ•°ï¼‰</option>
            <option value="manual">æ‰‹åŠ¨æ¨¡å¼</option>
        </select>
        <div id="manualControls" style="display:none;">
            <input type="number" id="imagesPerPrompt" placeholder="æ¯ä¸ªæç¤ºè¯ç”Ÿæˆçš„å›¾ç‰‡æ•°é‡" min="1" max="5">
            <input type="number" id="totalImages" placeholder="æ€»å›¾ç‰‡æ•°å¯é€‰ï¼‰" min="1">
        </div>
        <div class="advanced-settings">
            <h3>é«˜çº§è®¾ç½®</h3>
            <label for="imageSize">å›¾ç‰‡å°ºå¯¸ï¼š</label>
            <select id="imageSize">
                <option value="1024x1024">1024x1024</option>
                <option value="512x1024">512x1024</option>
                <option value="768x512">768x512</option>
                <option value="768x1024">768x1024</option>
                <option value="1024x576">1024x576</option>
                <option value="576x1024">576x1024</option>
            </select>
            <label for="seed">ç§å­å€¼ï¼ˆå¯é€‰ï¼‰ï¼š</label>
            <input type="number" id="seed" placeholder="è¾“å…¥ç§å­å€¼ï¼ˆ1-4294967295ï¼‰" min="1" max="4294967295">
        </div>
        <div id="generationControls">
            <button id="generateButton" onclick="startGeneration()">ç”Ÿæˆ</button>
            <button id="pauseButton" onclick="pauseGeneration()" style="display:none;">æš‚åœ</button>
            <button id="resumeButton" onclick="resumeGeneration()" style="display:none;">ç»§ç»­</button>
            <div class="tooltip">
                <button id="resetButton" onclick="resetGeneration()" style="display:none;">æ¸…ç©ºå¹¶ä¸”é‡å¯</button>
                <span class="tooltiptext">æŒ‰æ–°æç¤ºè¯é‡æ–°ç”Ÿæˆï¼Œ<br>è¯·æ³¨æ„ä¿å­˜ç°æœ‰å›¾ç‰‡ï¼</span>
            </div>
        </div>
        <div id="imageControls">
            <button id="selectAllButton" onclick="selectAllImages()">å…¨é€‰</button>
            <button id="downloadButton" onclick="downloadSelectedImages()">æ‰“åŒ…å›¾ç‰‡é“¾æ¥</button>
        </div>
        <div id="progressBar"><div id="progressBarFill"></div></div>
        <p id="progressText"></p>
        <div id="quotaInfo">APIé™é€Ÿï¼šæ¯åˆ†é’Ÿ2å¼ ï¼Œæ¯å¤©400å¼ ã€‚</div>
        <p id="quotaDisclaimer" style="font-size: 12px; color: #666;"></p>
        <div id="downloadInstructions">
            <p><strong>ä¸‹è½½è¯´æ˜ï¼š</strong></p>
            <ul>
                <li>å•ä¸ªå›¾ç‰‡ä¸‹è½½ï¼šå³é”®ç‚¹å‡»å›¾ç‰‡ï¼Œé€‰æ‹©"å›¾ç‰‡å¦å­˜ä¸º"å³å¯ä¿å­˜å•å¼ å›¾ç‰‡ã€‚</li>
                <li>æ‰¹é‡ä¸‹è½½ï¼š
                    <ol>
                        <li>é€‰æ‹©æƒ³è¦çš„å›¾ç‰‡ï¼ˆä½¿ç”¨æ¯å¼ å›¾ç‰‡ä¸Šæ–¹çš„å¤é€‰æ¡†ï¼‰ã€‚</li>
                        <li>ç‚¹å‡»"æ‰“åŒ…å›¾ç‰‡é“¾æ¥"æŒ‰é’®ï¼Œå°†è·å¾—ä¸€ä¸ªåŒ…å«æ‰€æœ‰é€‰ä¸­å›¾ç‰‡é“¾æ¥çš„æ–‡æœ¬æ–‡ä»¶ã€‚</li>
                        <li>å¯ä»¥å°è¯•ä½¿ç”¨ä¸‹è½½ç®¡ç†å™¨æˆ–æµè§ˆå™¨æ‰©å±•ï¼Œæˆ–ä½¿ç”¨Pythoné€šè¿‡APIç”Ÿæˆå›¾ç‰‡å¯ä»¥ç›´æ¥ä¿å­˜åœ¨æœ¬åœ°ã€‚</li>
                    </ol>
                </li>
            </ul>
        </div>
        <div id="imageContainer"></div>
    </div>

    <script>
        const API_URL = 'https://api.siliconflow.cn/v1/images/generations';
        let isGenerating = false;
        let isPaused = false;
        let totalGenerated = 0;
        let targetTotal = 0;
        let dailyQuota = 400;
        let dailyUsage = 0;
        let tokenBucket = 2;
        let lastRefillTime = Date.now();

        function refillTokenBucket() {
            const now = Date.now();
            const timePassed = now - lastRefillTime;
            const refillAmount = Math.floor(timePassed / 30000); // æ¯30ç§’æ¢å¤1ä¸ªä»¤ç‰Œ
            tokenBucket = Math.min(2, tokenBucket + refillAmount); // æœ€å¤š2ä¸ªä»¤ç‰Œ
            lastRefillTime = now;
        }

        document.getElementById('generationMode').addEventListener('change', function() {
            document.getElementById('manualControls').style.display = this.value === 'manual' ? 'block' : 'none';
        });

        function loadDailyUsage() {
            const today = new Date().toDateString();
            const storedData = JSON.parse(localStorage.getItem('fluxImageGeneratorUsage') || '{}');
            if (storedData.date === today) {
                dailyUsage = storedData.usage;
            } else {
                dailyUsage = 0;
                localStorage.setItem('fluxImageGeneratorUsage', JSON.stringify({ date: today, usage: 0 }));
            }
            updateQuotaInfo();
        }

        function updateDailyUsage() {
            dailyUsage++;
            const today = new Date().toDateString();
            localStorage.setItem('fluxImageGeneratorUsage', JSON.stringify({ date: today, usage: dailyUsage }));
            updateQuotaInfo();
        }

        function updateQuotaInfo() {
            const quotaInfo = document.getElementById('quotaInfo');
            const quotaDisclaimer = document.getElementById('quotaDisclaimer');

            if (!isGenerating) {
                quotaInfo.textContent = `APIé™é€Ÿï¼šæ¯åˆ†é’Ÿ2å¼ ï¼Œæ¯å¤©${dailyQuota}å¼ ã€‚`;
                quotaDisclaimer.textContent = '';
            } else {
                const remainingQuota = Math.max(0, dailyQuota - dailyUsage);
                quotaInfo.textContent = `ä»Šæ—¥é¢„ä¼°ä½¿ç”¨é‡ï¼š${dailyUsage}/${dailyQuota}ï¼Œå‰©ä½™é…é¢ï¼š${remainingQuota} å¼ `;
                quotaDisclaimer.textContent = 'æ³¨æ„ï¼šæ­¤ä¸ºæ ¹æ®æœ¬åœ°å­˜å‚¨é¢„ä¼°çš„ä½¿ç”¨é‡ï¼Œå®é™…ä»¥APIæœåŠ¡ç»Ÿè®¡ä¸ºå‡†ã€‚';
            }
        }

        async function generateImage(apiKey, prompt) {
            refillTokenBucket();
            if (tokenBucket < 1) {
                throw new Error('é€Ÿç‡é™åˆ¶ï¼šè¯·ç¨åå†è¯•');
            }
            tokenBucket--;

            const imageSize = document.getElementById('imageSize').value;
            const seed = document.getElementById('seed').value || 'éšæœº';

            const requestBody = {
                model: "black-forest-labs/FLUX.1-schnell",
                prompt: prompt,
                image_size: imageSize
            };

            if (seed !== 'éšæœº') {
                requestBody.seed = parseInt(seed);
            }

            if (dailyUsage >= dailyQuota) {
                throw new Error('å·²è¾¾åˆ°æ¯æ—¥é¢„ä¼°é…é¢ä¸Šé™ï¼ˆ400å¼ ï¼‰');
            }

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                let errorMessage = '';
                switch (response.status) {
                    case 400:
                        errorMessage = 'è¯·æ±‚æ— æ•ˆã€‚å¯èƒ½çš„åŸå› æ˜¯æç¤ºè¯æ ¼å¼ä¸æ­£ç¡®æˆ–ç¼ºå°‘å¿…è¦å‚æ•°ã€‚';
                        break;
                    case 401:
                        errorMessage = 'æœªç»æˆæƒã€‚å¯èƒ½çš„åŸå› æ˜¯APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸã€‚';
                        break;
                    case 404:
                        errorMessage = 'æœªæ‰¾åˆ°è¯·æ±‚çš„èµ„æºã€‚å¯èƒ½çš„åŸå› æ˜¯APIç«¯ç‚¹URLä¸æ­£ç¡®ã€‚';
                        break;
                    case 429:
                        errorMessage = 'è¯·æ±‚è¿‡å¤šã€‚å¯èƒ½çš„åŸå› æ˜¯è¶…å‡ºäº†APIçš„é€Ÿç‡é™åˆ¶ã€‚è¯·ç¨åå†è¯•æˆ–å‡çº§æ‚¨çš„è´¦æˆ·ã€‚';
                        break;
                    case 451:
                        errorMessage = 'ç”±äºæ³•å¾‹åŸå› æ— æ³•ç”Ÿæˆå›¾ç‰‡ã€‚å¯èƒ½çš„åŸå› æ˜¯æç¤ºè¯åŒ…å«æ•æ„Ÿæˆ–ä¸é€‚å½“çš„å†…å®¹ã€‚';
                        break;
                    case 503:
                        errorMessage = 'æœåŠ¡ä¸å¯ç”¨ã€‚å¯èƒ½çš„åŸå› æ˜¯æœåŠ¡å™¨æš‚æ—¶è¿‡è½½æˆ–æ­£åœ¨ç»´æŠ¤ã€‚';
                        break;
                    case 504:
                        errorMessage = 'ç½‘å…³è¶…æ—¶ã€‚å¯èƒ½çš„åŸå› æ˜¯æœåŠ¡å™¨å“åº”æ—¶é—´è¿‡é•¿ã€‚';
                        break;
                    default:
                        errorMessage = `æœªçŸ¥é”™è¯¯ã€‚HTTPçŠ¶æ€ç : ${response.status}`;
                }

                const errorBody = await response.text();
                throw new Error(`${errorMessage} æœåŠ¡å™¨å“åº”: ${errorBody}`);
            }

            const data = await response.json();
            updateDailyUsage();
            updateQuotaInfo();
            addImageToGallery(data.images[0].url, prompt, imageSize, seed);
            return data.images[0].url;
        }

        async function startGeneration() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                alert('è¯·è¾“å…¥APIå¯†é’¥');
                return;
            }

            const promptInput = document.getElementById('promptInput');
            const prompts = promptInput.value.split('\n').filter(prompt => prompt.trim() !== '').map(prompt => {
                const [text, weight] = prompt.split('+');
                return { text: text.trim(), weight: parseFloat(weight) || 1 };
            });

            const generationMode = document.getElementById('generationMode').value;
            let imagesPerPrompt = 1;
            if (generationMode === 'manual') {
                imagesPerPrompt = parseInt(document.getElementById('imagesPerPrompt').value) || 1;
                targetTotal = parseInt(document.getElementById('totalImages').value) || prompts.length * imagesPerPrompt;
            } else {
                // æ™ºèƒ½æ¨¡å¼ï¼šå¹³å‡åˆ†é…æ¯æ—¥é…é¢
                targetTotal = Math.min(dailyQuota, prompts.length * 5); // æ¯ä¸ªæç¤ºè¯æœ€å¤š5å¼ 
                imagesPerPrompt = Math.floor(targetTotal / prompts.length);
            }

            if (targetTotal > dailyQuota) {
                if (!confirm(`æ‚¨è®¾ç½®çš„ï¿½ï¿½å›¾ç‰‡æ•° ${targetTotal} è¶…è¿‡äº†æ¯æ—¥é™é¢ ${dailyQuota}ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                    return;
                }
            }

            document.getElementById('generateButton').style.display = 'none';
            document.getElementById('pauseButton').style.display = 'inline-block';
            document.getElementById('resetButton').style.display = 'inline-block';
            isGenerating = true;
            totalGenerated = 0;
            updateQuotaInfo();

            while (isGenerating && totalGenerated < targetTotal && totalGenerated < dailyQuota) {
                for (const prompt of prompts) {
                    for (let i = 0; i < imagesPerPrompt * prompt.weight; i++) {
                        if (isPaused) {
                            await new Promise(resolve => setTimeout(resolve, 1000)); // æ£€æŸ¥æ˜¯å¦æš‚åœ
                            continue;
                        }
                        if (totalGenerated >= targetTotal || totalGenerated >= dailyQuota) break;
                        try {
                            await generateImage(apiKey, prompt.text);
                            totalGenerated++;
                            updateProgress();
                        } catch (error) {
                            console.error('ç”Ÿæˆå›¾ç‰‡æ—¶å‡ºé”™:', error);
                            alert(`ç”Ÿæˆå›¾ç‰‡æ—¶å‡ºé”™: ${error.message}`);
                            // æ·»åŠ ä¸€ä¸ªçŸ­æš‚çš„æš‚åœï¼Œä»¥é˜²æ­¢è¿ç»­é”™è¯¯
                            await new Promise(resolve => setTimeout(resolve, 5000));
                        }
                        await new Promise(resolve => setTimeout(resolve, 30000)); // 30ç§’å»¶è¿Ÿ
                    }
                    if (totalGenerated >= targetTotal || totalGenerated >= dailyQuota) break;
                }
            }

            isGenerating = false;
            document.getElementById('generateButton').style.display = 'inline-block';
            document.getElementById('pauseButton').style.display = 'none';
            document.getElementById('resumeButton').style.display = 'none';
            document.getElementById('resetButton').style.display = 'none';
        }

        function addImageToGallery(imageUrl, prompt, size, seed) {
            const imageContainer = document.getElementById('imageContainer');
            const imageCard = document.createElement('div');
            imageCard.className = 'image-card';
            
            const imgWrapper = document.createElement('div');
            imgWrapper.className = 'image-wrapper';
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = prompt;
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'image-checkbox';
            
            imgWrapper.appendChild(img);
            imgWrapper.appendChild(checkbox);
            
            const promptPara = document.createElement('p');
            promptPara.textContent = prompt;
            promptPara.className = 'prompt';
            
            const sizePara = document.createElement('p');
            sizePara.textContent = `å°ºå¯¸: ${size}`;
            
            const seedPara = document.createElement('p');
            seedPara.textContent = `ç§å­: ${seed || 'éšæœº'}`;
            
            imageCard.appendChild(imgWrapper);
            imageCard.appendChild(promptPara);
            imageCard.appendChild(sizePara);
            imageCard.appendChild(seedPara);
            imageContainer.appendChild(imageCard);
        }

        function updateProgress() {
            const progressBar = document.getElementById('progressBarFill');
            const progressText = document.getElementById('progressText');
            const percentage = (totalGenerated / targetTotal) * 100;
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `å·²ç”Ÿæˆ ${totalGenerated} å¼ ï¼Œç›®æ ‡ ${targetTotal} å¼ `;
            updateQuotaInfo(); // æ›´æ–°é…é¢ä¿¡æ¯
        }

        function pauseGeneration() {
            isPaused = true;
            document.getElementById('pauseButton').style.display = 'none';
            document.getElementById('resumeButton').style.display = 'inline-block';
            isGenerating = false;
            updateQuotaInfo();
        }

        function resumeGeneration() {
            isPaused = false;
            document.getElementById('pauseButton').style.display = 'inline-block';
            document.getElementById('resumeButton').style.display = 'none';
            isGenerating = true;
            updateQuotaInfo();
        }

        function resetGeneration() {
            isGenerating = false;
            isPaused = false;
            totalGenerated = 0;
            targetTotal = 0;
            tokenBucket = 2;
            lastRefillTime = Date.now();
            document.getElementById('generateButton').style.display = 'inline-block';
            document.getElementById('pauseButton').style.display = 'none';
            document.getElementById('resumeButton').style.display = 'none';
            document.getElementById('resetButton').style.display = 'none';
            document.getElementById('imageContainer').innerHTML = '';
            updateProgress();
            loadDailyUsage(); // é‡æ–°åŠ è½½æ¯æ—¥ä½¿ç”¨é‡
            updateQuotaInfo();
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (document.body.classList.contains('dark-mode')) {
                darkModeToggle.textContent = 'ğŸŒ';
            } else {
                darkModeToggle.textContent = 'ğŸŒ“';
            }
        }

        function selectAllImages() {
            const checkboxes = document.querySelectorAll('.image-checkbox');
            const selectAllButton = document.getElementById('selectAllButton');
            const isSelectAll = selectAllButton.textContent === 'å…¨é€‰';
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = isSelectAll;
            });
            
            selectAllButton.textContent = isSelectAll ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰';
        }

        function downloadSelectedImages() {
            const selectedImages = document.querySelectorAll('.image-checkbox:checked');
            if (selectedImages.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ å›¾ç‰‡');
                return;
            }

            const imageUrls = Array.from(selectedImages).map(checkbox => {
                const imageCard = checkbox.closest('.image-card');
                return imageCard.querySelector('img').src;
            });

            const linksText = imageUrls.join('\n');
            const blob = new Blob([linksText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'image_links.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            URL.revokeObjectURL(url);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            loadDailyUsage();
            isGenerating = false;
            updateQuotaInfo();
            // ... å…¶ä»–åˆå§‹åŒ–ä»£ç  ...
        };
    </script>
</body>
</html>
