<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flux æ‰¹é‡ç”Ÿå›¾å°å·¥å…·</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css">
    <style>
        body {
            font-family: "LXGW WenKai", sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
            color: #333;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
        }
        textarea, input, select {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            min-width: 120px;
        }
        button:hover {
            background-color: #2980b9;
        }
        #imageContainer {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }
        .image-card {
            width: 30%;
            margin-bottom: 20px;
            text-align: center;
            background-color: #fff;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            overflow: hidden;
            padding-bottom: 10px;
        }
        .image-card img {
            max-width: 100%;
            height: auto;
            display: block;
            margin-bottom: 10px;
        }
        .image-checkbox {
            display: block;
            margin: 10px auto;
        }
        .image-card p {
            margin: 5px 0;
            padding: 0 10px;
        }
        #progressBar {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        #progressBar div {
            height: 20px;
            background-color: #2ecc71;
            text-align: center;
            line-height: 20px;
            color: white;
            transition: width 0.5s;
        }
        #quotaInfo {
            margin-top: 10px;
            font-size: 14px;
            color: #7f8c8d;
        }
        .dark-mode {
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        .dark-mode .container {
            background-color: #34495e;
        }
        .dark-mode h1 {
            color: #3498db;
        }
        .dark-mode textarea, .dark-mode input, .dark-mode select {
            background-color: #2c3e50;
            color: #ecf0f1;
            border-color: #7f8c8d;
        }
        .dark-mode button {
            background-color: #e74c3c;
        }
        .dark-mode button:hover {
            background-color: #c0392b;
        }
        .dark-mode .image-card {
            background-color: #34495e;
            color: #ecf0f1;
        }
        .dark-mode #progressBar {
            background-color: #7f8c8d;
        }
        .advanced-settings {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .advanced-settings h3 {
            margin-top: 0;
        }
        .advanced-settings label {
            display: block;
            margin-bottom: 5px;
        }
        .api-key-hint {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
            margin-bottom: 10px;
        }
        .dark-mode .api-key-hint {
            color: #bdc3c7;
        }
        #promptHelperButton {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
        }
        #promptHelperButton:hover {
            background-color: #27ae60;
        }
        #promptInstructions {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        #promptInstructions pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        #promptInstructions a {
            color: #3498db;
            text-decoration: none;
        }
        #promptInstructions a:hover {
            text-decoration: underline;
        }
        #promptInput {
            width: 100%;
            margin-bottom: 20px;
        }
        label[for="promptInput"], .advanced-settings h3 {
            display: block;
            margin-bottom: 10px;
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        .dark-mode label[for="promptInput"], .dark-mode .advanced-settings h3 {
            color: #3498db;
        }
        #progressBar {
            margin-top: 20px;
        }
        #progressText, #quotaInfo {
            margin-top: 10px;
        }
        .dark-mode #promptInstructions {
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        .dark-mode #promptInstructions a {
            color: #3498db;
        }
        .dark-mode #promptInstructions pre {
            background-color: #34495e;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
        }
        .dark-mode .advanced-settings {
            background-color: #34495e;
            color: #ecf0f1;
        }
        .dark-mode .advanced-settings select,
        .dark-mode .advanced-settings input {
            background-color: #2c3e50;
            color: #ecf0f1;
            border-color: #7f8c8d;
        }
        a {
            color: #3498db;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .dark-mode a {
            color: #5dade2;
        }
        .dark-mode a:hover {
            color: #3498db;
        }
        .red-text {
            color: #e74c3c;
        }
        .image-checkbox {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
        }
        .image-card {
            position: relative;
        }
        #selectAllButton, #downloadButton {
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .checkbox-label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        .image-checkbox {
            margin-right: 5px;
        }
        #downloadInstructions {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        #downloadInstructions ul {
            padding-left: 20px;
        }
        .dark-mode #downloadInstructions {
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        .dark-mode .checkbox-label {
            background-color: rgba(52, 73, 94, 0.7);
            color: #ecf0f1;
        }
        .checkbox-wrapper {
            text-align: left;
            padding: 0 10px;
            margin-top: 5px;
        }
        .image-checkbox {
            margin: 0;
        }
        .image-wrapper {
            position: relative;
        }
        .image-card img {
            max-width: 100%;
            height: auto;
            display: block;
        }
        .image-checkbox {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
        }
        .image-card p {
            margin: 10px 0;
            padding: 0 10px;
        }
        #apiKeyInput, #promptInput, #seed, #generationMode {
            width: 100%;
        }
        .image-card p.prompt {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 2.4em;  /* å‡è®¾è¡Œé«˜ä¸º1.2em */
            line-height: 1.2em;
        }
        #darkModeToggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 24px;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px; /* å¢åŠ å®½åº¦ */
            background-color: black;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px; /* è°ƒæ•´å·¦è¾¹è·ä»¥ä¿æŒå±…ä¸­ */
            white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
        }
        .image-card p {
            margin: 5px 0;
            padding: 0 10px;
            font-size: 14px;
        }
        .image-card .prompt {
            font-weight: bold;
            margin-bottom: 10px;
        }
        #resetButton {
            background-color: #e74c3c;
        }
        #resetButton:hover {
            background-color: #c0392b;
        }
        #selectAllButton, #downloadButton, #resetButton {
            display: inline-block;
            vertical-align: middle;
        }
        .tooltip {
            display: inline-block;
            vertical-align: middle;
        }
        #generationControls, #imageControls {
            margin-bottom: 10px;
        }
        #generationControls button, #imageControls button {
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        .tooltip {
            display: inline-block;
            vertical-align: middle;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 14px;
            min-width: 120px;
        }
        button:hover {
            background-color: #2980b9;
        }
        #resetButton {
            background-color: #e74c3c;
        }
        #resetButton:hover {
            background-color: #c0392b;
        }
        #resetButton, #downloadButton {
            min-width: 140px;  /* ç¨å¾®å¢åŠ å®½åº¦ä»¥é€‚åº”æ›´é•¿çš„æ–‡æœ¬ */
        }
        /* æ·»åŠ ä»¥ä¸‹æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
        }
        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
        }
        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
        }
        .close:hover,
        .close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }
        /* æ·»åŠ æ–°çš„æ ·å¼ */
        #notificationArea {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .notification {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            max-width: 300px;
            animation: fadeInOut 5s ease-in-out;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }
        #statusIndicator {
            margin-top: 10px;
            font-size: 14px;
            color: #7f8c8d;
        }

        @keyframes buffer {
            0% { background-position: 0 0; }
            100% { background-position: 70px 0; }
        }

        #progressBar.buffering div {
            background-image: linear-gradient(
                -45deg,
                rgba(255, 255, 255, 0.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0.2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 50px 50px;
            animation: buffer 1s linear infinite;
        }

        .dark-mode #progressBar.buffering div {
            background-image: linear-gradient(
                -45deg,
                rgba(0, 0, 0, 0.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(0, 0, 0, 0.2) 50%,
                rgba(0, 0, 0, 0.2) 75%,
                transparent 75%,
                transparent
            );
        }

        .dark-mode #resetButton {
            background-color: #e67e22; /* æ·±æ©™è‰² */
        }

        .dark-mode #resetButton:hover {
            background-color: #d35400; /* é¼ æ ‡æ‚¬åœæ—¶çš„æ·±æ©™è‰² */
        }
    </style>
</head>
<body>
    <div class="container">
        <button id="darkModeToggle" onclick="toggleDarkMode()">ğŸŒ“</button>
        <h1>Flux æ‰¹é‡ç”Ÿå›¾å°å·¥å…·</h1>
        <p>æ„Ÿè°¢<a href="https://www.siliconflow.com/" target="_blank">ç¡…åŸºæµåŠ¨</a>æä¾›çš„APIæ”¯æŒã€‚è¯·å‹¿æ»¥ç”¨æ­¤å·¥å…·ï¼Œéµå®ˆç›¸å…³æ³•å¾‹æ³•è§„ã€‚</p>
        <input type="password" id="apiKeyInput" placeholder="è¾“å…¥æ‚¨çš„APIå¯†é’¥">
        <p class="api-key-hint">æ³¨å†Œç¡…åŸºæµåŠ¨ä¹‹åï¼Œè¿›å…¥è´¦æˆ·ç®¡ç†ï¼Œæ–°å»ºAPIå¯†é’¥å³å¯ã€‚</p>
        <div id="promptInstructions">
            <p><strong class="red-text">æç¤ºè¯å¿…é¡»æ˜¯è‹±æ–‡ã€‚æ¯è¡Œå†™ä¸€åˆ™æç¤ºè¯ï¼›åªè¦æŒ‰"å›è½¦"é”®ï¼Œå°±ä¼šå¼€å§‹ä¸€åˆ™æ–°çš„æç¤ºè¯ã€‚</strong></p>
            <p>æ ¼å¼ï¼šæç¤ºè¯+æƒé‡ï¼ˆæƒé‡å¯é€‰ï¼Œä¸å†™å°±é»˜è®¤ä¸º1ï¼›æƒé‡è¶Šé«˜ï¼Œä½¿ç”¨è¯¥æç¤ºè¯ç”Ÿæˆå›¾ç‰‡çš„æ¬¡æ•°è¶Šå¤šã€‚ï¼‰</p>
            <p>ç¤ºä¾‹ï¼š</p>
            <pre>
A beautiful garden with blooming flowers under bright sunlight+1
Launch the space shuttle from the base
Graceful Song dynasty palace maid, modest light-colored silk ruqun with flowing sleeves, high-waisted skirt, simple yet elegant hairstyle with jade hairpin, calm demeanor, arranging peonies in a blue-and-white porcelain vase, standing in a refined scholar's garden, soft afternoon light, photorealistic style+2</pre>
            <p>éœ€è¦å¸®åŠ©ç”Ÿæˆæç¤ºè¯ï¼Ÿå¯ä»¥å‚è€ƒ<a href="https://www.coze.cn/store/agent/7411101906900140070" target="_blank">æç¤ºè¯ç”ŸæˆåŠ©æ‰‹</a>ã€‚</p>
            <p><strong>æ³¨æ„ï¼šå¦‚æœåŠ©æ‰‹ç”Ÿæˆçš„ä¸€åˆ™æç¤ºè¯åŒ…å«äº†å¤šæ®µæ–‡å­—ï¼Œå°±æ‰‹åŠ¨æ”¹æ”¹æ ¼å¼ï¼Œä»¥å…å› è·¨è¡Œè¢«è¯¯åˆ¤ä¸ºå¤šåˆ™æç¤ºè¯ã€‚</strong></p>
        </div>
        <label for="promptInput"><strong>åœ¨ä¸‹æ–¹è¾“å…¥æ‚¨çš„æç¤ºè¯ï¼š</strong></label>
        <textarea id="promptInput" rows="10"></textarea>
        <select id="generationMode">
            <option value="smart">æ™ºèƒ½æ¨¡å¼ï¼ˆè‡ªåŠ¨åˆ†é…ç”Ÿæˆæ¬¡æ•°ï¼‰</option>
            <option value="manual">æ‰‹åŠ¨æ¨¡å¼</option>
        </select>
        <div id="manualControls" style="display:none;">
            <input type="number" id="imagesPerPrompt" placeholder="æ¯ä¸ªæç¤ºè¯ç”Ÿæˆçš„å›¾ç‰‡æ•°é‡" min="1" max="5">
            <input type="number" id="totalImages" placeholder="æ€»å›¾ç‰‡æ•°ï¼ˆå¯é€‰ï¼‰" min="1">
        </div>
        <div class="advanced-settings">
            <h3>é«˜çº§è®¾ç½®</h3>
            <label for="imageSize">å›¾ç‰‡å°ºå¯¸ï¼š</label>
            <select id="imageSize">
                <option value="1024x1024">1024x1024</option>
                <option value="512x1024">512x1024</option>
                <option value="768x512">768x512</option>
                <option value="768x1024">768x1024</option>
                <option value="1024x576">1024x576</option>
                <option value="576x1024">576x1024</option>
            </select>
            <label for="seed">ç§å­å€¼ï¼ˆå¯é€‰ï¼‰ï¼š</label>
            <input type="number" id="seed" placeholder=" 1-4294967295" min="1" max="4294967295">
        </div>
        <div id="generationControls">
            <button id="generateButton" onclick="startGeneration()">ç”Ÿæˆ</button>
            <button id="pauseButton" onclick="togglePause()" style="display:none;">æš‚åœ</button>
            <div class="tooltip">
                <button id="resetButton" onclick="resetGeneration()">æ¸…ç©ºå¹¶ä¸”é‡å¯</button>
                <span class="tooltiptext">æŒ‰æ–°æç¤ºè¯é‡æ–°ç”Ÿæˆï¼Œ<br>è¯·æ³¨æ„ä¿å­˜ç°æœ‰å›¾ç‰‡ï¼</span>
            </div>
        </div>
        <div id="imageControls">
            <button id="selectAllButton" onclick="selectAllImages()">å…¨é€‰</button>
            <button id="downloadButton" onclick="downloadSelectedImages()">æ‰“åŒ…å›¾ç‰‡é“¾æ¥</button>
        </div>
        <div id="progressBar"><div id="progressBarFill"></div></div>
        <p id="progressText"></p>
        <div id="quotaInfo">APIé™é€Ÿï¼šæ¯åˆ†é’Ÿ2å¼ ï¼Œæ¯å¤©400å¼ ã€‚</div>
        <p id="quotaDisclaimer" style="font-size: 12px; color: #666;"></p>
        <div id="downloadInstructions">
            <p><strong>ä¸‹è½½è¯´æ˜ï¼š</strong></p>
            <ul>
                <li>å•ä¸ªå›¾ç‰‡ä¸‹è½½ï¼šå³é”®ç‚¹å‡»å›¾ç‰‡ï¼Œé€‰æ‹©"å›¾ç‰‡å¦å­˜ä¸º"å³å¯ä¿å­˜å•å¼ å›¾ç‰‡ã€‚</li>
                <li>æ‰¹é‡ä¸‹è½½ï¼š
                    <ol>
                        <li>é€‰æ‹©æƒ³è¦çš„å›¾ç‰‡ï¼ˆä½¿ç”¨æ¯å¼ å›¾ç‰‡ä¸Šæ–¹çš„å¤é€‰æ¡†ï¼‰ã€‚</li>
                        <li>ç‚¹å‡»"æ‰“åŒ…å›¾ç‰‡é“¾æ¥"ï¼Œè·å¾—çš„ä»…ä»…æ˜¯ä¸€å †URLï¼Œè¿˜éœ€è¦å†å¤„ç†ã€‚</li>
                        <li>å¯ä»¥å°è¯•ä½¿ç”¨æµè§ˆå™¨æ‰©å±•ï¼Œæ¯”å¦‚ <a href="https://www.pullywood.com/ImageAssistant/" target="blank">å›¾ç‰‡åŠ©æ‰‹</a> æˆ– <a href="https://cn.eagle.cool/" target="blank">Eagle</a> (åè€…éœ€è¦è´­ä¹°)ã€‚</li>
                    </ol>
                </li>
            </ul>
        </div>
        <div id="imageContainer"></div>
        <div id="statusIndicator" class="status-indicator"></div>
    </div>

    <!-- æ·»åŠ ä»¥ä¸‹æ¨¡æ€æ¡† -->
    <div id="imageModal" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <div id="notificationArea"></div>

    <script>
        const API_URL = 'https://api.siliconflow.cn/v1/images/generations';
        let isGenerating = false;
        let isPaused = false;
        let totalGenerated = 0;
        let targetTotal = 0;
        let dailyQuota = 400;
        let dailyUsage = 0;
        let tokenBucket = 2;
        let lastRefillTime = Date.now();
        let cooldownTimer = 0;
        const REFILL_RATE = 30000; // æ¯30ç§’æ·»åŠ ä¸€ä¸ªä»¤ç‰Œ
        const MAX_TOKENS = 2; // æœ€å¤§ä»¤ç‰Œæ•°
        let progressInterval; // æ–°å¢å˜é‡æ¥æ§åˆ¶è¿›åº¦æ¡æ›´æ–°

        function showNotification(message, duration = 5000) {
            const notificationArea = document.getElementById('notificationArea');
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notificationArea.appendChild(notification);
            setTimeout(() => {
                notificationArea.removeChild(notification);
            }, duration);
        }

        function refillTokenBucket() {
            const now = Date.now();
            const timePassed = now - lastRefillTime;
            const newTokens = Math.floor(timePassed / REFILL_RATE);
            if (newTokens > 0) {
                tokenBucket = Math.min(MAX_TOKENS, tokenBucket + newTokens);
                lastRefillTime = now;
            }
        }

        async function generateImage(apiKey, prompt) {
            refillTokenBucket();
            if (tokenBucket < 1) {
                setBufferingState(true);
                await new Promise(resolve => setTimeout(resolve, REFILL_RATE));
                setBufferingState(false);
                return null;
            }
            tokenBucket--;

            try {
                const imageSize = document.getElementById('imageSize').value;
                const seed = document.getElementById('seed').value || 'éšæœº';

                const requestBody = {
                    model: "black-forest-labs/FLUX.1-schnell",
                    prompt: prompt,
                    image_size: imageSize
                };

                if (seed !== 'éšæœº') {
                    requestBody.seed = parseInt(seed);
                }

                if (dailyUsage >= dailyQuota) {
                    showNotification('å·²è¾¾åˆ°æ¯æ—¥é¢„ä¼°é…é¢ä¸Šé™ï¼ˆ400å¼ ï¼‰');
                    return;
                }

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    let errorMessage = '';
                    switch (response.status) {
                        case 400:
                            errorMessage = 'è¯·æ±‚æ— æ•ˆã€‚å¯èƒ½çš„åŸå› æ˜¯æç¤ºè¯æ ¼å¼ä¸æ­£ç¡®æˆ–ç¼ºå°‘å¿…è¦å‚æ•°ã€‚';
                            break;
                        case 401:
                            errorMessage = 'æœªç»æˆæƒã€‚å¯èƒ½çš„åŸå› æ˜¯APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸã€‚';
                            break;
                        case 404:
                            errorMessage = 'æœªæ‰¾åˆ°è¯·æ±‚çš„èµ„æºã€‚å¯èƒ½çš„åŸå› æ˜¯APIç«¯ç‚¹URLä¸æ­£ç¡®ã€‚';
                            break;
                        case 429:
                            errorMessage = 'è¯·æ±‚è¿‡å¤šã€‚å¯èƒ½çš„åŸå› æ˜¯è¶…å‡ºäº†APIçš„é€Ÿç‡é™åˆ¶ã€‚è¯·ç¨åå†è¯•æˆ–å‡çº§æ‚¨çš„è´¦æˆ·ã€‚';
                            break;
                        case 451:
                            errorMessage = 'ç”±äºæ³•å¾‹åŸå› æ— æ³•ç”Ÿæˆå›¾ç‰‡ã€‚å¯èƒ½çš„åŸå› æ˜¯æç¤ºè¯åŒ…å«æ•æ„Ÿæˆ–ä¸é€‚å½“çš„å†…å®¹ã€‚';
                            break;
                        case 503:
                            errorMessage = 'æœåŠ¡ä¸å¯ç”¨ã€‚å¯èƒ½çš„åŸå› æ˜¯æœåŠ¡å™¨æš‚æ—¶è¿‡è½½æˆ–æ­£åœ¨ç»´æŠ¤ã€‚';
                            break;
                        case 504:
                            errorMessage = 'ç½‘å…³è¶…æ—¶ã€‚å¯èƒ½çš„åŸå› æ˜¯æœåŠ¡å™¨å“åº”æ—¶é—´è¿‡é•¿ã€‚';
                            break;
                        default:
                            errorMessage = `æœªçŸ¥é”™è¯¯ã€‚HTTPçŠ¶æ€ç : ${response.status}`;
                    }

                    const errorBody = await response.text();
                    throw new Error(`${errorMessage} æœåŠ¡å™¨å“åº”: ${errorBody}`);
                }

                const data = await response.json();
                updateDailyUsage();
                updateQuotaInfo();
                addImageToGallery(data.images[0].url, prompt, imageSize, seed);
                totalGenerated++;
                updateProgress();
                return data.images[0].url;
            } catch (error) {
                console.error('ç”Ÿæˆå›¾ç‰‡æ—¶å‡ºé”™:', error);
                showNotification(`ç”Ÿæˆå›¾ç‰‡æ—¶å‡ºé”™: ${error.message}`);
                setBufferingState(true);
                await new Promise(resolve => setTimeout(resolve, 30000)); // 30ç§’å†·å´
                setBufferingState(false);
                return null;
            }
        }

        async function startGeneration() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                showNotification('è¯·è¾“å…¥APIå¯†é’¥');
                return;
            }

            const promptInput = document.getElementById('promptInput');
            const prompts = promptInput.value.split('\n').filter(prompt => prompt.trim() !== '').map(prompt => {
                const [text, weight] = prompt.split('+');
                return { text: text.trim(), weight: parseFloat(weight) || 1 };
            });

            const generationMode = document.getElementById('generationMode').value;
            let imagesPerPrompt = 1;
            if (generationMode === 'manual') {
                imagesPerPrompt = parseInt(document.getElementById('imagesPerPrompt').value) || 1;
                targetTotal = parseInt(document.getElementById('totalImages').value) || prompts.length * imagesPerPrompt;
            } else {
                // æ™ºèƒ½æ¨¡å¼ï¼šå¹³å‡åˆ†é…æ¯æ—¥é…é¢
                targetTotal = Math.min(dailyQuota, prompts.length * 5); // æ¯ä¸ªæç¤ºè¯æœ€å¤š5å¼ 
                imagesPerPrompt = Math.floor(targetTotal / prompts.length);
            }

            if (targetTotal > dailyQuota) {
                showNotification(`æ‚¨è®¾ç½®çš„å›¾ç‰‡æ•° ${targetTotal} è¶…è¿‡äº†æ¯æ—¥é™é¢ ${dailyQuota}ã€‚å°†ç”Ÿæˆ ${dailyQuota} å¼ å›¾ç‰‡ã€‚`);
                targetTotal = dailyQuota;
            }

            document.getElementById('generateButton').style.display = 'none';
            document.getElementById('pauseButton').style.display = 'inline-block';
            isGenerating = true;
            totalGenerated = 0; // é‡ç½®è®¡æ•°å™¨
            updateProgress(); // åˆå§‹åŒ–è¿›åº¦æ˜¾ç¤ºï¼Œç§»é™¤äº†é¢å¤–çš„å‚æ•°
            updateQuotaInfo();

            while (isGenerating && totalGenerated < targetTotal && totalGenerated < dailyQuota) {
                for (const prompt of prompts) {
                    if (isPaused) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        continue;
                    }
                    if (totalGenerated >= targetTotal || totalGenerated >= dailyQuota) break;
                    const result = await generateImage(apiKey, prompt.text);
                    if (result) {
                        updateProgress();
                    } else {
                        await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…1ç§’å†é‡è¯•
                    }
                }
            }

            isGenerating = false;
            document.getElementById('generateButton').style.display = 'inline-block';
            document.getElementById('pauseButton').style.display = 'none';
            updateQuotaInfo();
        }

        function addImageToGallery(imageUrl, prompt, size, seed) {
            const imageContainer = document.getElementById('imageContainer');
            const imageCard = document.createElement('div');
            imageCard.className = 'image-card';
            
            const imgWrapper = document.createElement('div');
            imgWrapper.className = 'image-wrapper';
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = prompt;
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'image-checkbox';
            
            imgWrapper.appendChild(img);
            imgWrapper.appendChild(checkbox);
            
            const promptPara = document.createElement('p');
            promptPara.textContent = prompt;
            promptPara.className = 'prompt';
            
            const sizePara = document.createElement('p');
            sizePara.textContent = `å°ºå¯¸: ${size}`;
            
            const seedPara = document.createElement('p');
            seedPara.textContent = `ç§å­: ${seed || 'éšæœº'}`;
            
            imageCard.appendChild(imgWrapper);
            imageCard.appendChild(promptPara);
            imageCard.appendChild(sizePara);
            imageCard.appendChild(seedPara);
            imageContainer.appendChild(imageCard);
            
            img.onclick = function() {
                openModal(imageUrl);
            };

            // æ·»åŠ ä»¥ä¸‹ä»£ç åœ¨å‡½æ•°æœ«å°¾
            updateSelectAllButtonState();
        }

        function updateProgress() {
            if (isPaused) {
                return; // å¦‚æœæš‚åœäº†ï¼Œä¸æ›´æ–°è¿›åº¦æ¡
            }
            const progressBar = document.getElementById('progressBarFill');
            const progressText = document.getElementById('progressText');
            const percentage = (totalGenerated / targetTotal) * 100;
            progressBar.style.width = `${percentage}%`;
            
            // åªæ˜¾ç¤ºæ€»è¿›åº¦ä¿¡æ¯
            const totalProgressLine = `æ€»è¿›åº¦: å·²ç”Ÿæˆ ${totalGenerated} å¼  | ç›®æ ‡ ${targetTotal} å¼ `;
            
            progressText.textContent = totalProgressLine;
            
            const remainingQuota = Math.max(0, dailyQuota - dailyUsage);
            const statusText = `ä»Šæ—¥å·²ç”Ÿæˆ: ${dailyUsage}/${dailyQuota} | å‰©ä½™é…é¢: ${remainingQuota}`;
            updateStatusIndicator(statusText);
        }

        function togglePause() {
            if (isPaused) {
                isPaused = false;
                document.getElementById('pauseButton').textContent = 'æš‚åœ';
                continueGeneration();
                startProgressBar(); // æ¢å¤è¿›åº¦æ¡
            } else {
                isPaused = true;
                document.getElementById('pauseButton').textContent = 'ç»§ç»­';
                stopProgressBar(); // ç«‹å³åœæ­¢è¿›åº¦æ¡
            }
        }

        function startProgressBar() {
            clearInterval(progressInterval); // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            progressInterval = setInterval(updateProgress, 100);
        }

        function stopProgressBar() {
            clearInterval(progressInterval);
        }

        function continueGeneration() {
            if (!isPaused) {
                generateNextImage();
            }
        }

        function generateNextImage() {
            if (isPaused) {
                return;
            }
            // ... ç°æœ‰çš„ç”Ÿæˆé€»è¾‘ ...
            startProgressBar(); // ç¡®ä¿åœ¨å¼€å§‹ç”Ÿæˆæ—¶å¯åŠ¨è¿›åº¦æ¡
        }

        // åœ¨åˆå§‹åŒ–å‡½æ•°ä¸­å¯åŠ¨è¿›åº¦æ¡
        function initializeGenerator() {
            // ... ç°æœ‰çš„åˆå§‹åŒ–é€»è¾‘ ...
            startProgressBar();
        }

        function resetGeneration() {
            isGenerating = false;
            isPaused = false;
            totalGenerated = 0;
            targetTotal = 0;
            tokenBucket = 2;
            lastRefillTime = Date.now();
            document.getElementById('generateButton').style.display = 'inline-block';
            document.getElementById('pauseButton').style.display = 'none';
            document.getElementById('imageContainer').innerHTML = '';
            updateProgress();
            loadDailyUsage(); // é‡æ–°åŠ è½½æ¯æ—¥ä½¿ç”¨é‡
            updateQuotaInfo();

            // é‡ç½®"å…¨é€‰/å–æ¶ˆå…¨é€‰"æŒ‰é’®
            const selectAllButton = document.getElementById('selectAllButton');
            selectAllButton.textContent = 'å…¨é€‰';
            selectAllButton.dataset.state = 'select'; // æ·»åŠ ä¸€ä¸ªæ•°æ®å±æ€§æ¥è·Ÿè¸ªçŠ¶æ€

            // ç¡®ä¿ tooltiptext å­˜åœ¨å¹¶å¯è§
            const clearRestartButton = document.getElementById('resetButton');
            let tooltip = clearRestartButton.querySelector('.tooltiptext');
            if (!tooltip) {
                tooltip = document.createElement('span');
                tooltip.className = 'tooltiptext';
                tooltip.innerHTML = 'æŒ‰æ–°æç¤ºè¯é‡æ–°ç”Ÿæˆï¼Œ<br>è¯·æ³¨æ„ä¿å­˜ç°æœ‰å›¾ç‰‡ï¼';
                clearRestartButton.appendChild(tooltip);
            }
            tooltip.style.visibility = 'hidden'; // å…ˆéšè—,ä»¥é¿å…é‡æ–°è§¦å‘hoveræ•ˆæœ

            // ä½¿ç”¨ setTimeout æ¥ç¡®ä¿ tooltiptext åœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­é‡æ–°æ˜¾ç¤º
            setTimeout(() => {
                tooltip.style.visibility = '';
            }, 0);

            showNotification('å·²æ¸…ç©ºç”»å»Šå¹¶é‡ç½®ç”Ÿæˆè®¡æ•°');
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (document.body.classList.contains('dark-mode')) {
                darkModeToggle.textContent = 'ğŸŒ';
            } else {
                darkModeToggle.textContent = 'ğŸŒ“';
            }
        }

        function selectAllImages() {
            const checkboxes = document.querySelectorAll('.image-checkbox');
            const selectAllButton = document.getElementById('selectAllButton');
            const isSelectAll = selectAllButton.dataset.state === 'select';
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = isSelectAll;
            });
            
            if (isSelectAll) {
                selectAllButton.textContent = 'å–æ¶ˆå…¨é€‰';
                selectAllButton.dataset.state = 'deselect';
            } else {
                selectAllButton.textContent = 'å…¨é€‰';
                selectAllButton.dataset.state = 'select';
            }
        }

        function downloadSelectedImages() {
            const selectedImages = document.querySelectorAll('.image-checkbox:checked');
            if (selectedImages.length === 0) {
                showNotification('è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ å›¾ç‰‡');
                return;
            }

            const imageUrls = Array.from(selectedImages).map(checkbox => {
                const imageCard = checkbox.closest('.image-card');
                return imageCard.querySelector('img').src;
            });

            const linksText = imageUrls.join('\n');
            const blob = new Blob([linksText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'image_links.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            URL.revokeObjectURL(url);
        }

        // æ·»åŠ ä»¥ä¸‹å‡½æ•°
        function openModal(imageUrl) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = "block";
            modalImg.src = imageUrl;
        }

        // å…³é—­æ¨¡æ€æ¡†
        const modal = document.getElementById('imageModal');
        const span = document.getElementsByClassName("close")[0];
        span.onclick = function() {
            modal.style.display = "none";
        }
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            loadDailyUsage();
            isGenerating = false;
            updateQuotaInfo();
            // ... å…¶ä»–åˆå§‹åŒ–ä»£ç  ...
        };

        document.getElementById('generationMode').addEventListener('change', function() {
            document.getElementById('manualControls').style.display = this.value === 'manual' ? 'block' : 'none';
        });

        function loadDailyUsage() {
            const today = new Date().toDateString();
            const storedData = JSON.parse(localStorage.getItem('fluxImageGeneratorUsage') || '{}');
            if (storedData.date === today) {
                dailyUsage = storedData.usage;
            } else {
                dailyUsage = 0;
                localStorage.setItem('fluxImageGeneratorUsage', JSON.stringify({ date: today, usage: 0 }));
            }
            updateQuotaInfo();
        }

        function updateDailyUsage() {
            dailyUsage++;
            const today = new Date().toDateString();
            localStorage.setItem('fluxImageGeneratorUsage', JSON.stringify({ date: today, usage: dailyUsage }));
            updateQuotaInfo();
        }

        function updateQuotaInfo() {
            const quotaInfo = document.getElementById('quotaInfo');
            const quotaDisclaimer = document.getElementById('quotaDisclaimer');

            if (!isGenerating) {
                quotaInfo.textContent = `APIé™é€Ÿï¼šæ¯åˆ†é’Ÿ2å¼ ï¼Œæ¯å¤©${dailyQuota}å¼ ã€‚`;
                quotaDisclaimer.textContent = '';
            } else {
                const remainingQuota = Math.max(0, dailyQuota - dailyUsage);
                quotaInfo.textContent = `ä»Šæ—¥é¢„ä¼°ä½¿ç”¨é‡ï¼š${dailyUsage}/${dailyQuota}ï¼Œå‰©ä½™é…é¢ï¼š${remainingQuota} å¼ `;
                quotaDisclaimer.textContent = 'æ³¨æ„ï¼šæ­¤ä¸ºæ ¹æ®æœ¬åœ°å­˜å‚¨é¢„ä¼°çš„ä½¿ç”¨é‡ï¼Œå®é™…ä»¥APIæœåŠ¡ç»Ÿè®¡ä¸ºå‡†ã€‚';
            }
        }

        // ç§»é™¤ window.onerror å¤„ç†ç¨‹åºï¼Œæ”¹ç”¨ try-catch å¤„ç†å…·ä½“é”™è¯¯

        // åœ¨é¡µé¢åŠ è½½å®Œæˆåï¼Œç¡®ä¿ tooltiptext å­˜åœ¨
        window.addEventListener('load', function() {
            const clearRestartButton = document.getElementById('resetButton');
            if (!clearRestartButton.querySelector('.tooltiptext')) {
                const tooltip = document.createElement('span');
                tooltip.className = 'tooltiptext';
                tooltip.innerHTML = 'æŒ‰æ–°æç¤ºè¯é‡æ–°ç”Ÿæˆï¼Œ<br>è¯·æ³¨æ„ä¿å­˜ç°æœ‰å›¾ç‰‡ï¼';
                clearRestartButton.appendChild(tooltip);
            }
        });

        function updateSelectAllButtonState() {
            const checkboxes = document.querySelectorAll('.image-checkbox');
            const selectAllButton = document.getElementById('selectAllButton');
            const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
            
            if (allChecked) {
                selectAllButton.textContent = 'å–æ¶ˆå…¨é€‰';
                selectAllButton.dataset.state = 'deselect';
            } else {
                selectAllButton.textContent = 'å…¨é€‰';
                selectAllButton.dataset.state = 'select';
            }
        }

        function updateStatusIndicator(status) {
            const statusIndicator = document.getElementById('statusIndicator');
            statusIndicator.textContent = status;
        }

        function setBufferingState(isBuffering) {
            const progressBar = document.getElementById('progressBar');
            if (isBuffering) {
                progressBar.classList.add('buffering');
            } else {
                progressBar.classList.remove('buffering');
            }
        }
    </script>
</body>
</html>
